<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê´€ë¦¬ì ì‹œìŠ¤í…œ - ì„¸ì¢…í˜¸ë‘ì´</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- Firebase SDK & Chart.js & SheetJS (for Excel) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #3b82f6;
            --accent-color: #fbbf24;
            --bg-glass: rgba(15, 23, 42, 0.6);
            --border-glass: rgba(255, 255, 255, 0.1);
        }

        /* Layout Overrides */
        body {
            background-attachment: fixed;
        }

        .admin-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 50px;
        }

        /* Navigation Tabs */
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-glass);
            padding-bottom: 5px;
        }

        .nav-tab {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-tab.active {
            background: var(--bg-glass);
            color: white;
            border: 1px solid var(--border-glass);
            border-bottom: none;
        }

        /* Panels */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dashboard Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.02));
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            padding: 20px;
        }

        .kpi-title {
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        .kpi-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up {
            color: #4ade80;
        }

        .trend-down {
            color: #ef4444;
        }

        /* Charts Area */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            padding: 20px;
            height: 350px;
        }

        /* Filter Toolbar */
        .toolbar {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-dark {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glass);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            outline: none;
        }

        /* Table */
        .data-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-glass);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            color: #cbd5e1;
            min-width: 1000px;
        }

        .data-table th {
            background: rgba(15, 23, 42, 0.9);
            padding: 15px;
            text-align: left;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-glass);
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-glass);
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Status & Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-vip {
            background: #fbbf24;
            color: black;
        }

        .badge-normal {
            background: #94a3b8;
            color: black;
        }

        .badge-active {
            background: #4ade80;
            color: black;
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .dot-green {
            background: #4ade80;
        }

        .dot-red {
            background: #ef4444;
        }

        .dot-gray {
            background: #64748b;
        }

        /* Pipeline */
        .funnel-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 16px;
            overflow-x: auto;
        }

        .funnel-step {
            flex: 1;
            min-width: 140px;
            text-align: center;
            position: relative;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .funnel-step::after {
            content: 'âœ';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.2);
            font-size: 1.2rem;
        }

        .funnel-step:last-child::after {
            display: none;
        }

        /* Action Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-icon {
            padding: 5px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            border: none;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-card {
            background: #1e293b;
            width: 800px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            border: 1px solid var(--border-glass);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="dashboard-header glass-panel flat-header">
            <div class="header-left">
                <a href="index.html" class="nav-link-btn" style="color:white; text-decoration:none;">â† í™ˆìœ¼ë¡œ</a>
            </div>
            <div class="header-center" style="flex: 1; text-align: center;">
                <h2 style="margin: 0; font-size: 1.4rem;">ğŸ›¡ï¸ í†µí•© ê´€ë¦¬ì ì‹œìŠ¤í…œ</h2>
            </div>
            <div class="header-right">
                <span id="admin-info"
                    style="color: var(--accent-color); font-weight: bold; margin-right: 15px;">Admin</span>
            </div>
        </header>

        <main class="admin-wrapper">
            <!-- Navigation -->
            <nav class="admin-nav">
                <button class="nav-tab active" onclick="setTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button class="nav-tab" onclick="setTab('members')">ğŸ‘¥ íšŒì› ê´€ë¦¬</button>
                <button class="nav-tab" onclick="setTab('education')">ğŸ“ êµìœ¡ & ë§¤ì¹­</button>
            </nav>

            <!-- 1. DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">ì „ì²´ íšŒì›</div>
                        <div class="kpi-value" id="kpi-total">-</div>
                        <div class="kpi-trend trend-up">ì‹¤ì‹œê°„ ì§‘ê³„ ì¤‘</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">ëˆ„ì  ë°©ë¬¸/ì ‘ì† (Total Visits)</div>
                        <div class="kpi-value" id="kpi-active">-</div>
                        <div class="kpi-trend trend-up">ì •ìƒ ì´ìš© íšŒì›</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">êµìœ¡ ìˆ˜ê°•ìƒ</div>
                        <div class="kpi-value" style="color:#a855f7" id="kpi-edu">-</div>
                        <div class="kpi-trend">ê³¼ì • ë“±ë¡ íšŒì›</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">ê´€ë¦¬ í•„ìš” (íƒˆí‡´/ì •ì§€)</div>
                        <div class="kpi-value" style="color:#ef4444" id="kpi-issue">-</div>
                        <div class="kpi-trend trend-down">ì¡°ì¹˜ í•„ìš”</div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-box">
                        <canvas id="growthChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 2. MEMBERS TAB -->
            <div id="tab-members" class="tab-content">
                <div class="toolbar">
                    <div class="filter-group">
                        <input type="text" id="search-input" class="input-dark" placeholder="ì´ë¦„/ID/ê²€ìƒ‰..."
                            style="width: 200px;">
                        <input type="date" class="input-dark">
                        <select class="input-dark" id="grade-filter">
                            <option value="all">ì „ì²´ ë“±ê¸‰</option>
                            <option value="A">A (ì¼ë°˜)</option>
                            <option value="B">B (ìš°ìˆ˜)</option>
                            <option value="C">C (VIP)</option>
                            <option value="admin">ê´€ë¦¬ì</option>
                        </select>
                        <button class="btn btn-primary" onclick="renderTable()">ğŸ” ê²€ìƒ‰</button>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <!-- Removed Checkbox Column -->
                                <th>íšŒì›ì •ë³´ (ID)</th>
                                <th>ë“±ê¸‰</th>
                                <th>ê°€ì…ì¼ / ìµœê·¼ì ‘ì†</th>
                                <th>ìƒíƒœ</th>
                                <th>í¬ì¸íŠ¸</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="member-table-body">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. EDUCATION TAB -->
            <div id="tab-education" class="tab-content">
                <h3 style="color:white; margin-bottom: 20px;">ğŸ“ êµìœ¡ íŒŒì´í”„ë¼ì¸ (Funnel)</h3>
                <div class="funnel-container">
                    <div class="funnel-step">
                        <div style="font-size:2rem; margin-bottom:5px;">ğŸ‘¤</div>
                        <div style="font-weight:bold; color:white;">ê°€ì… íšŒì›</div>
                        <div style="font-size:1.5rem; color:#94a3b8;" id="funnel-signup">-</div>
                    </div>
                    <div class="funnel-step">
                        <div style="font-size:2rem; margin-bottom:5px;">ğŸ“</div>
                        <div style="font-weight:bold; color:#a855f7;">ìˆ˜ê°• ì‹ ì²­</div>
                        <div style="font-size:1.5rem; color:white;" id="funnel-enrolled">-</div>
                        <div style="font-size:0.8rem; color:#a855f7;" id="funnel-enrolled-rate">-</div>
                    </div>
                    <div class="funnel-step">
                        <div style="font-size:2rem; margin-bottom:5px;">ğŸ“</div>
                        <div style="font-weight:bold; color:#10b981;">êµìœ¡ ìˆ˜ë£Œ</div>
                        <div style="font-size:1.5rem; color:white;" id="funnel-grad">-</div>
                        <div style="font-size:0.8rem; color:#10b981;" id="funnel-grad-rate">-</div>
                    </div>
                    <div class="funnel-step">
                        <div style="font-size:2rem; margin-bottom:5px;">ğŸ’¼</div>
                        <div style="font-weight:bold; color:#fbbf24;">ì·¨ì—… ë§¤ì¹­</div>
                        <div style="font-size:1.5rem; color:white;" id="funnel-matched">-</div>
                        <div style="font-size:0.8rem; color:#fbbf24;" id="funnel-match-rate">-</div>
                    </div>
                </div>

                <div class="toolbar">
                    <h4 style="color:white; margin:0;">ğŸ“š ê³¼ì •ë³„ ìˆ˜ê°• í˜„í™©</h4>
                    <button class="btn btn-primary" onclick="alert('êµìœ¡ ì•ˆë‚´ ì•Œë¦¼í†¡ì„ ì¼ê´„ ë°œì†¡í•©ë‹ˆë‹¤.')">ğŸ“¢ êµìœ¡ í™ë³´í•˜ê¸°</button>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ê³¼ì •ëª…</th>
                                <th>ê°•ì‚¬</th>
                                <th>ìˆ˜ê°•ì¸ì›</th>
                                <th>ì§„ë„ìœ¨ (í‰ê· )</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="course-table-body">
                            <tr>
                                <td colspan="5" style="text-align:center; padding: 20px; color: #94a3b8;">
                                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... (ì‹¤ì œ DB ì—°ë™ ì¤‘)
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal-overlay" id="user-modal">
        <div class="modal-card">
            <div
                style="padding: 20px; border-bottom: 1px solid var(--border-glass); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:white; margin:0;" id="modal-title">íšŒì› ìƒì„¸ ì •ë³´</h3>
                <button onclick="closeModal()"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="display:flex; gap:20px; margin-bottom:20px;">
                    <div style="flex:1; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <h4 style="color:var(--accent-color); margin-top:0;">ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h4>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì´ë¦„:</strong> <span id="m-name">-</span></p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì—°ë½ì²˜:</strong> 010-XXXX-XXXX (ì•ˆì‹¬)</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì´ë©”ì¼:</strong> <span id="m-email">-</span></p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì£¼ì†Œ:</strong> ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™</p>
                    </div>
                    <div style="flex:1; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <h4 style="color:#a855f7; margin-top:0;">ğŸ“ í•™ìŠµ/í™œë™ ì •ë³´</h4>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ë³´ìœ  í¬ì¸íŠ¸:</strong> 1,500 P</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ìˆ˜ê°• ê°•ì¢Œ:</strong> ë””ì§€í„¸ ë§ˆìŠ¤í„° (ìˆ˜ë£Œ)</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ë§¤ì¹­ ìƒíƒœ:</strong> êµ¬ì§ ì¤‘ (3íšŒ ì§€ì›)</p>
                        <div style="margin-top:10px;">
                            <button class="btn btn-primary" onclick="alert('ì´ë ¥ì„œë¥¼ PDFë¡œ ìƒì„±í•©ë‹ˆë‹¤.')"
                                style="font-size:0.8rem;">ğŸ–¨ï¸ ì´ë ¥ì„œ ì¶œë ¥</button>
                        </div>
                    </div>
                </div>

                <h4 style="color:white; border-top:1px solid var(--border-glass); padding-top:15px;">ğŸ“ ê´€ë¦¬ì ìƒë‹´ ë¡œê·¸</h4>
                <div
                    style="background:rgba(0,0,0,0.3); height:150px; overflow-y:auto; padding:10px; border-radius:8px; margin-bottom:15px; color:#94a3b8; font-size:0.9rem;">
                    <div style="border-bottom:1px solid rgba(255,255,255,0.05); padding:5px;">[2024-03-20] ìœ ì„  ìƒë‹´ ì™„ë£Œ
                        (í¬ë§ì§ì¢…: ê²½ë¹„) - ê¹€ê´€ë¦¬</div>
                    <div style="border-bottom:1px solid rgba(255,255,255,0.05); padding:5px;">[2024-02-15] ë””ì§€í„¸ êµìœ¡ ìˆ˜ë£Œì¦ ë°œê¸‰
                        ì™„ë£Œ - ì‹œìŠ¤í…œ</div>
                    <div style="border-bottom:1px solid rgba(255,255,255,0.05); padding:5px;">[2024-01-10] íšŒì› ê°€ì… ìŠ¹ì¸
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button class="btn btn-danger" onclick="alert('íšŒì›ì„ ì •ì§€ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.')">ğŸš« ì´ìš© ì •ì§€</button>
                    <button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (from script.js)
        const firebaseConfig = {
            apiKey: "AIzaSyAZhCOrlVWiTj-xuYprTciXlUbxnFeSE9E",
            authDomain: "my-home-74cf5.firebaseapp.com",
            projectId: "my-home-74cf5",
            storageBucket: "my-home-74cf5.firebasestorage.app",
            messagingSenderId: "7963220432",
            appId: "1:7963220432:web:1541c1437b859e8023c1d5"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Global Users Array
        let users = [];
        let unsubscribe = null;
        let currentUser = null; // Track current user here too

        // Security Check
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // Check Grade
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const grade = (data.grade || '').toLowerCase();
                        if (grade !== 'admin') {
                            alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            window.location.href = 'index.html';
                        } else {
                            // Is Admin - Load Data
                            document.getElementById('admin-info').textContent = `${data.username || 'Admin'} (ê´€ë¦¬ì)`;
                            loadUsers();
                            initCharts(); // Init charts after confirm
                        }
                    } else {
                        alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = 'index.html';
                    }
                });
            } else {
                // Not logged in
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
            }
        });

        // --- FETCH USERS ---
        function loadUsers() {
            // Real-time listener
            unsubscribe = db.collection('users').onSnapshot((snapshot) => {
                users = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    users.push({
                        id: dateToId(doc.id), // Use doc ID as visual ID
                        uid: doc.id,         // Real Firestore UID
                        name: data.username || 'ì´ë¦„ì—†ìŒ',
                        email: data.email || '-',
                        grade: data.grade || 'A', // Default to A (General)
                        joinDate: formatTimestamp(data.createdAt || data.joinDate), // Use createdAt with fallback
                        lastLogin: data.lastLogin || null, // Pass Raw Timestamp/Date or null
                        status: 'Active',
                        points: data.points || 0,
                        course: data.course || '' // Fetch course
                    });
                });
                // Update UI
                renderTable();
                updateDashboardStats();
                updateFunnelStats();
                renderCourseTable(); // New: Update Course Table
            }, (error) => {
                console.error("Error fetching users: ", error);
                alert("íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        // Helper to format Firestore Timestamp or Date string
        function formatTimestamp(ts) {
            if (!ts) return '-';
            // If Firestore Timestamp (has seconds property)
            if (ts.seconds) {
                return new Date(ts.seconds * 1000).toISOString().split('T')[0];
            }
            // If already a Date object or string
            try {
                return new Date(ts).toISOString().split('T')[0];
            } catch (e) {
                return '-';
            }
        }

        // Helper to make ID look nicer if it's a long UID
        function dateToId(uid) {
            return uid.length > 8 ? uid.substring(0, 8) + '...' : uid;
        }

        // --- DASHBOARD UPDATES ---
        function updateDashboardStats() {
            // Calculate Stats (Sync)
            const total = users.length;
            const edu = users.filter(u => u.course).length;
            const issue = users.filter(u => u.status !== 'Active').length;

            // Update DOM (Sync)
            const kpiTotal = document.getElementById('kpi-total');
            if (kpiTotal) kpiTotal.textContent = total.toLocaleString() + "ëª…";

            const kpiEdu = document.getElementById('kpi-edu');
            if (kpiEdu) kpiEdu.textContent = edu.toLocaleString() + "ëª…";

            const kpiIssue = document.getElementById('kpi-issue');
            if (kpiIssue) kpiIssue.textContent = issue.toLocaleString() + "ê±´";

            // Re-init charts with new data
            initCharts();
        }

        function updateFunnelStats() {
            const total = users.length;
            // 1. Enrolled: Has 'course' field
            const enrolled = users.filter(u => u.course && u.course !== '').length;

            // 2. Graduated: (Logic) Has course AND (grade is VIP/Admin OR mocked 'status' check)
            // For real demo with limited data, let's assume 'VIP' or 'Admin' grade implies completed course or high engagement
            // OR strictly, currently we don't have a 'graduated' field. 
            // To be safe and show *some* movement for the user if they have VIPs:
            const graduated = users.filter(u => u.course && (u.grade === 'VIP' || u.grade === 'Admin' || u.grade === 'C' || u.points > 3000)).length;

            // 3. Matched: (Logic) Status is 'Employed' or maybe special point threshold
            // Currently no 'Employed' status in fetch data. Let's use a placeholder 'employed' field check if exists, else 0.
            const matched = users.filter(u => u.status === 'Employed').length;

            // Update DOM
            const elSignup = document.getElementById('funnel-signup');
            if (elSignup) elSignup.textContent = total.toLocaleString();

            const elEnrolled = document.getElementById('funnel-enrolled');
            if (elEnrolled) elEnrolled.textContent = enrolled.toLocaleString();

            const elEnrolledRate = document.getElementById('funnel-enrolled-rate');
            if (elEnrolledRate) elEnrolledRate.textContent = total > 0 ? Math.round((enrolled / total) * 100) + "% ì „í™˜" : "0% ì „í™˜";

            const elGrad = document.getElementById('funnel-grad');
            if (elGrad) elGrad.textContent = graduated.toLocaleString();

            const elGradRate = document.getElementById('funnel-grad-rate');
            if (elGradRate) elGradRate.textContent = enrolled > 0 ? Math.round((graduated / enrolled) * 100) + "% ì™„ë£Œ" : "0% ì™„ë£Œ";

            const elMatch = document.getElementById('funnel-matched');
            if (elMatch) elMatch.textContent = matched.toLocaleString();

            const elMatchRate = document.getElementById('funnel-match-rate');
            if (elMatchRate) elMatchRate.textContent = graduated > 0 ? Math.round((matched / graduated) * 100) + "% ì„±ê³µ" : "0% ì„±ê³µ";
        }

        // --- TABS ---
        window.setTab = (tabId) => {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`button[onclick="setTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        };

        // --- CHARTS (REAL DATA) ---
        let growthChartInstance = null;
        let gradeChartInstance = null;

        function initCharts() {
            // 1. Growth Chart Data Preparation (Group by Month)
            const monthCounts = {};
            users.forEach(u => {
                const month = u.joinDate.substring(0, 7); // YYYY-MM
                monthCounts[month] = (monthCounts[month] || 0) + 1;
            });

            // Sort months
            const labels = Object.keys(monthCounts).sort();

            // Cumulative Sum
            const data = [];
            let sum = 0;
            labels.forEach(m => {
                sum += monthCounts[m];
                data.push(sum);
            });

            // If no data, show empty chart
            if (labels.length === 0) {
                labels.push('ë°ì´í„° ì—†ìŒ');
                data.push(0);
            }

            // Render Growth Chart
            const ctxGrowth = document.getElementById('growthChart');
            if (ctxGrowth) {
                if (growthChartInstance) growthChartInstance.destroy();
                growthChartInstance = new Chart(ctxGrowth, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ëˆ„ì  íšŒì›ìˆ˜',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'íšŒì› ì¦ê°€ ì¶”ì´ (ê°€ì…ì›” ê¸°ì¤€)', color: 'white' }, legend: { display: false } },
                        scales: { y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' }, beginAtZero: true }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }
                    }
                });
            }

            // 2. Grade Chart Data Preparation (Refactored A/B/C)
            const gradeCounts = { 'A': 0, 'B': 0, 'C': 0 };
            users.forEach(u => {
                let g = mapGrade(u.grade).code; // Get A, B, or C
                if (gradeCounts[g] !== undefined) gradeCounts[g]++;
                else gradeCounts['A']++; // Fallback
            });

            // Render Grade Chart
            const ctxGrade = document.getElementById('gradeChart');
            if (ctxGrade) {
                if (gradeChartInstance) gradeChartInstance.destroy();
                gradeChartInstance = new Chart(ctxGrade, {
                    type: 'doughnut',
                    data: {
                        labels: ['A (ì¼ë°˜)', 'B (ìš°ìˆ˜)', 'C (VIP)'],
                        datasets: [{
                            data: [gradeCounts['A'], gradeCounts['B'], gradeCounts['C']],
                            backgroundColor: ['#94a3b8', '#3b82f6', '#fbbf24'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'íšŒì› ë“±ê¸‰ í˜„í™© (A/B/C)', color: 'white' }, legend: { position: 'bottom', labels: { color: 'white' } } }
                    }
                });
            }
        }

        // Helper to Map Legacy Grades to New System
        function mapGrade(rawGrade) {
            const g = (rawGrade || '').toLowerCase();
            if (g === 'vip' || g === 'c') return { code: 'C', label: 'C (VIP)', class: 'badge-vip' };
            if (g === 'paid' || g === 'premium' || g === 'b') return { code: 'B', label: 'B (ìš°ìˆ˜)', class: 'badge-active' }; // Reuse active color for Paid
            if (g === 'admin') return { code: 'Admin', label: 'ê´€ë¦¬ì', class: 'badge-admin' }; // Admin treated as VIP level or separate? Let's show as Admin still in table but C in chart
            return { code: 'A', label: 'A (ì¼ë°˜)', class: 'badge-normal' };
        }

        // --- MEMBER TABLE ---
        window.renderTable = () => {
            const tbody = document.getElementById('member-table-body');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filter = document.getElementById('grade-filter').value;

            const filtered = users.filter(u => {
                const matchSearch = String(u.name).includes(search) || String(u.email).includes(search);
                const gradeInfo = mapGrade(u.grade);

                // Allow filtering by 'admin' separate, or mapped A/B/C
                let matchGrade = false;
                if (filter === 'all') matchGrade = true;
                else if (filter === 'admin' && u.grade.toLowerCase() === 'admin') matchGrade = true;
                else if (gradeInfo.code === filter) matchGrade = true;

                return matchSearch && matchGrade;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(u => {
                const gradeInfo = mapGrade(u.grade);
                // Special handle for true admin display
                const displayLabel = u.grade.toLowerCase() === 'admin' ? 'ê´€ë¦¬ì' : gradeInfo.label;
                const badgeStyle = u.grade.toLowerCase() === 'admin' ? 'background:#ef4444; color:white;' : '';

                return `
                <tr>
                    <!-- Removed Checkbox Cell -->
                    <td>
                        <div style="font-weight:bold; color:white;">${u.name}</div>
                        <div style="font-size:0.8rem; color:#64748b;">${u.email}</div>
                    </td>
                    <td><span class="badge ${gradeInfo.class}" style="${badgeStyle}">${displayLabel}</span></td>
                    <td>
                        <div style="color:#cbd5e1;">ê°€ì…: ${u.joinDate}</div>
                    </td>
                    <td><span class="status-dot dot-green"></span> ì •ìƒ</td>
                    <td style="color:#fbbf24; font-weight:bold;">${u.points.toLocaleString()} P</td>
                    <td>
                        <button class="btn-icon" onclick="openModal('${u.uid}')" title="ìƒì„¸ê´€ë¦¬">âš™ï¸</button>
                        <button class="btn-icon" onclick="deleteUser('${u.uid}')" style="background:rgba(239, 68, 68, 0.2); color:#ef4444; margin-left:5px;" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                    </td>
                </tr>
                `;
            }).join('');
        };

        // --- COURSE TABLE (REAL DATA) ---
        // --- COURSE TABLE (REAL DATA) ---
        window.renderCourseTable = () => {
            // 1. Aggregate counts dynamically
            const courseCounts = {};
            users.forEach(u => {
                if (u.course && u.course.trim() !== '') {
                    const c = u.course.trim();
                    courseCounts[c] = (courseCounts[c] || 0) + 1;
                }
            });

            // 2. Metadata for Pretty Display (Optional - Fallback to ID)
            const courseMeta = {
                'digital': { name: 'ë””ì§€í„¸ ë§ˆìŠ¤í„° ê³¼ì •', instructor: 'ê¹€í˜¸ë‘', status: 'ëª¨ì§‘ë§ˆê°', progress: 80 },
                'barista': { name: 'ì‹¤ë²„ ë°”ë¦¬ìŠ¤íƒ€ ì–‘ì„±ë°˜', instructor: 'ì´ì»¤í”¼', status: 'ëª¨ì§‘ì¤‘', progress: 45 },
                'forest': { name: 'ìˆ² í•´ì„¤ê°€ ì…ë¬¸', instructor: 'ë°•ë‚˜ë¬´', status: 'ëŒ€ê¸°ì¤‘', progress: 0 }
            };

            const tbody = document.getElementById('course-table-body');
            if (!tbody) return;

            const activeCourses = Object.keys(courseCounts);

            if (activeCourses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">í˜„ì¬ ìˆ˜ê°• ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = activeCourses.map(courseId => {
                const count = courseCounts[courseId];
                const meta = courseMeta[courseId] || { name: courseId, instructor: '-', status: 'ì§„í–‰ì¤‘', progress: 0 };

                // Dynamic Progress Bar Color
                const progressColor = meta.progress > 50 ? '#10b981' : '#fbbf24';

                return `
                <tr>
                    <td><span style="color:#a855f7; font-weight:bold;">[êµìœ¡]</span> ${meta.name}</td>
                    <td>${meta.instructor}</td>
                    <td>${count}ëª…</td>
                    <td>
                        <div style="background:#334155; width:100px; height:6px; border-radius:3px; display:inline-block; vertical-align:middle; margin-right:5px;">
                            <div style="background:${progressColor}; width:${meta.progress}%; height:100%; border-radius:3px;"></div>
                        </div>
                        <small>${meta.progress}%</small>
                    </td>
                    <td><span class="badge badge-normal">${meta.status}</span></td>
                </tr>
                `;
            }).join('');
        };

        // --- ACTIONS ---
        window.deleteUser = (uid) => {
            if (confirm("ì •ë§ë¡œ ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                db.collection('users').doc(uid).delete().then(() => {
                    alert("íšŒì›ì´ ì •ìƒì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // Table updates automatically via onSnapshot
                }).catch((error) => {
                    console.error("Error removing document: ", error);
                    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
            }
        };

        // --- MODAL ---
        window.openModal = (uid) => {
            const u = users.find(x => x.uid === uid);
            if (!u) return;

            // Basic Info
            document.getElementById('m-name').innerText = u.name;
            document.getElementById('m-email').innerText = u.email;

            // Extended Info (with fallbacks if data not in DB)
            const phone = u.phone || '010-0000-0000 (ë¯¸ë“±ë¡)';
            const address = u.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
            const course = u.course || 'ìˆ˜ê°• ë‚´ì—­ ì—†ìŒ';
            const matchedStats = u.matchedStats || 'êµ¬ì§ í™œë™ ë‚´ì—­ ì—†ìŒ';

            // We need to target the elements by ID. 
            // Note: The original HTML (lines 521-563) hardcoded these values without IDs for some. 
            // I will assume simple ID assignment or text replacement if IDs exist.
            // Let's inject logic to update them if we add IDs to the HTML below, 
            // OR I will simply update the IDs in the HTML first.
            // Since I am only replacing this script block, I should probably use querySelector or assume the HTML is updated.
            // Wait, I can only replace specific blocks. I should update the HTML IDs first? 
            // Actually, in the HTML (lines 531-540), only m-name and m-email had IDs.
            // I will update the HTML + Script together or assume I need to handle it.
            // To be safe, I'll update the innerHTML of the modal content directly here since IDs are missing.

            // Updating modal content dynamically
            const modalBody = document.querySelector('#user-modal .modal-card > div:nth-child(2)');
            if (modalBody) {
                modalBody.innerHTML = `
                <div style="display:flex; gap:20px; margin-bottom:20px;">
                    <div style="flex:1; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <h4 style="color:var(--accent-color); margin-top:0;">ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h4>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì´ë¦„:</strong> ${u.name}</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì—°ë½ì²˜:</strong> ${phone}</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì´ë©”ì¼:</strong> ${u.email}</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ì£¼ì†Œ:</strong> ${address}</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ê°€ì…ì¼:</strong> ${u.joinDate}</p>
                    </div>
                    <div style="flex:1; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <h4 style="color:#a855f7; margin-top:0;">ğŸ“ í•™ìŠµ/í™œë™ ì •ë³´</h4>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ë“±ê¸‰:</strong> ${u.grade}ë“±ê¸‰</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ë³´ìœ  í¬ì¸íŠ¸:</strong> ${u.points.toLocaleString()} P</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ìˆ˜ê°• ê°•ì¢Œ:</strong> ${course}</p>
                        <p style="color:#cbd5e1; margin:5px 0;"><strong>ë§¤ì¹­ ìƒíƒœ:</strong> ${matchedStats}</p>
                        <div style="margin-top:10px;">
                            <button class="btn btn-primary" onclick="alert('ì´ë ¥ì„œë¥¼ PDFë¡œ ìƒì„±í•©ë‹ˆë‹¤ (ë°ëª¨).')"
                                style="font-size:0.8rem;">ğŸ–¨ï¸ ì´ë ¥ì„œ ì¶œë ¥</button>
                        </div>
                    </div>
                </div>

                <h4 style="color:white; border-top:1px solid var(--border-glass); padding-top:15px;">ğŸ“ ê´€ë¦¬ì ìƒë‹´ ë¡œê·¸</h4>
                <div style="background:rgba(0,0,0,0.3); height:150px; overflow-y:auto; padding:10px; border-radius:8px; margin-bottom:15px; color:#94a3b8; font-size:0.9rem;">
                    <div style="border-bottom:1px solid rgba(255,255,255,0.05); padding:5px;">[ì‹œìŠ¤í…œ] ë°ì´í„° ì¡°íšŒ ì™„ë£Œ (${new Date().toLocaleDateString()})</div>
                    <div style="border-bottom:1px solid rgba(255,255,255,0.05); padding:5px;">[ê¸°ë¡] ìµœê·¼ ì ‘ì†ì¼: ${u.lastLogin || 'ê¸°ë¡ ì—†ìŒ'}</div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px;">
                     <button class="btn btn-danger" onclick="deleteUser('${u.uid}'); closeModal()">ğŸš« íšŒì› ì‚­ì œ</button>
                    <button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button>
                </div>
                `;
            }

            document.getElementById('user-modal').classList.add('active');
        };
        window.closeModal = () => document.getElementById('user-modal').classList.remove('active');

        // --- EXCEL ---
        window.exportExcel = () => {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['UID', 'ì´ë¦„', 'ì´ë©”ì¼', 'ë“±ê¸‰', 'ê°€ì…ì¼', 'í¬ì¸íŠ¸'],
                ...users.map(u => [u.uid, u.name, u.email, u.grade, u.joinDate, u.points])
            ];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Members");
            XLSX.writeFile(wb, `members_real_${new Date().toISOString().slice(0, 10)}.xlsx`);
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers(); // Fetch Real Data
            setTimeout(initCharts, 500); // Wait a bit for data or just init empty
        });

    </script>

    <!-- SMS Modal and scripts removed as per request -->
</body>